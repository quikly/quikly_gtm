___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Quikly GTM Template",
  "categories": ["ADVERTISING", "CONVERSIONS", "EMAIL_MARKETING", "MARKETING"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Google tag manager template that contains the Quikly snippet.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "host",
    "displayName": "Script Tag Host",
    "selectItems": [
      {
        "value": "https://pixel.quikly.com/",
        "displayValue": "Quikly Live"
      },
      {
        "value": "https://pixel.quiklydemo.com/",
        "displayValue": "Quikly Demo"
      }
    ],
    "simpleValueType": true,
    "macrosInSelect": false,
    "defaultValue": "https://pixel.quikly.com/"
  },
  {
    "type": "TEXT",
    "name": "configKey",
    "displayName": "Config Key",
    "simpleValueType": true,
    "canBeEmptyString": false
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Enter your template code here.
const copyFromWindow = require('copyFromWindow');
const injectScript = require('injectScript');
const log = require('logToConsole');
const queryPermission = require('queryPermission');
const setInWindow = require('setInWindow');

log('Custom Template data =', data);
const src = data.host + 'embed/js';
log('script src =', src);

const qDataPermission = queryPermission('access_globals', 'readwrite', 'qData');
const qDataLayerPermission = queryPermission('access_globals', 'readwrite', 'qDataLayer');
const quiklyPermissions = qDataPermission && qDataLayerPermission;

var qDataLayer = copyFromWindow('qDataLayer');
var qData = copyFromWindow('qData');

const onSuccess = () => {
  log('Quikly embed script injected successfully');
  
  if (quiklyPermissions) {
    log('Script injected successfully');
    qData = copyFromWindow('qData');
    qDataLayer = copyFromWindow('qDataLayer');
  } else {
    log('Script does not have permission to modify qData');
    data.gtmOnFailure();
  }
  
  if (qData) {
    log('qData successfully assigned by Quikly script:', qData);
  }
  if (qDataLayer) {
    log('qDataLayer successfully assigned by Quikly script:', qDataLayer);
  }
  
  if (!qData) {
    log('qData was not  by script, assign it now.');
    qData = function() {
      log('(qDataLayer ? qDataLayer : []):', (qDataLayer ? qDataLayer : []));
      qDataLayer = qDataLayer ? qDataLayer : [];
      qDataLayer.push(arguments);
      
      log('Setting qDataLayer as', qDataLayer);
      setInWindow('qDataLayer', qDataLayer, true);
    };
    if (!setInWindow('qData', qData, true)) {
      log('Failed to set qData as', qData);
      data.gtmOnFailure();
      return;
    }
  }
  
  log("Calling qData('config', 'm/" + data.configKey + "' )");
  qData('config', 'm/' + data.configKey);
  qData('ui', {
    placements: 'auto',
    platformData: {
      platform: 'shopify',
      // template: '{{ template.name }}',
      // page: '{{ page.handle }}'
    }
  });
  
  data.gtmOnSuccess();
};

const onFailure = () => {
  log('Failed to inject Quikly embed script');
  data.gtmOnFailure();
};


if (!qDataLayer || !qData) {
  log('no qDataLayer or qData, injecting script');
  injectScript(src, onSuccess, onFailure);
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "qData"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "qDataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://pixel.quikly.com/embed/js"
              },
              {
                "type": 1,
                "string": "https://pixel.quiklydemo.com/embed/js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 8/23/2023, 10:48:11 PM


